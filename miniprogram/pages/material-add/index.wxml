<!--pages/material-add/index.wxml-->
<view class="container">
  <!-- 顶部 Tab 切换 -->
  <van-tabs active="{{ activeTab }}" bind:change="onTabChange" color="#1989fa" sticky>
    <van-tab title="化材入库" name="chemical"></van-tab>
    <van-tab title="膜材入库" name="film"></van-tab>
  </van-tabs>

  <view class="p-15">
    <!-- 0. 顶部操作区 -->
    <view class="mb-15 flex-row justify-between items-center">
        <van-button icon="apps-o" plain type="primary" size="small" bind:click="goToBatchEntry" custom-style="flex: 1; margin-right: 10px;">批量模式</van-button>
        <van-button icon="records" plain type="info" size="small" bind:click="goToMyRequests" custom-style="flex: 1;">我的申请</van-button>
    </view>

    <!-- 1. 唯一码录入 (置顶) -->
    <view class="form-card bg-white rounded-lg overflow-hidden shadow-sm mb-15">
        <van-cell-group title="标签信息 (必填)">
            <van-field
                value="{{ form.unique_code }}"
                label="标签编号"
                placeholder="扫码/手动输入"
                required
                clearable
                center
                data-field="unique_code"
                bind:change="onInput"
                use-button-slot
                class="scanning-field"
                label-class="field-label-bold"
            >
                <van-button slot="button" size="mini" type="info" icon="scan" custom-class="scan-btn" bind:click="onScanCode">
                    扫码
                </van-button>
            </van-field>
        </van-cell-group>
    </view>

    <!-- 强管控：未知代码阻断 -->
    <view wx:if="{{isUnknownCode}}" class="bg-white rounded-lg shadow-sm p-20 text-center mb-15">
        <van-icon name="warning-o" size="48px" color="#ee0a24" />
        <view class="text-lg font-bold mt-10 text-dark">非标物料阻断</view>
        <view class="text-sm text-secondary mt-10 mb-20 text-left">
            代码 <text class="font-bold text-primary">{{form.product_code}}</text> 未在标准库中找到。
            <view class="mt-5">根据实验室 MDM 规范，禁止随意录入非标物料。</view>
            <view>请先提交建档申请，管理员审批通过后方可入库。</view>
        </view>
        <view class="flex-row">
            <van-button type="info" block round bind:click="showRequestPopup" custom-class="flex-1 mr-10">立即申请建档</van-button>
            <van-button type="default" block round bind:click="onEditCode" custom-class="flex-1">修改代码</van-button>
        </view>
    </view>

    <!-- 正常填单区域 (只有代码已知时显示) -->
    <view wx:else class="form-card bg-white rounded-lg overflow-hidden shadow-sm">
      <van-cell-group title="基础信息">
        <!-- 1. 产品代码 (SKU) -->
        <van-field
          value="{{ form.product_code }}"
          label="产品代码"
          placeholder="请输入数字 (如 001)"
          required
          type="number"
          data-field="product_code"
          bind:change="onInput"
          class="product-code-field {{ activeTab }}"
          label-class="field-label-bold"
        />

        <!-- 2. 物料名称 -->
        <van-field
          value="{{ form.name }}"
          label="物料名称"
          placeholder="{{ activeTab === 'chemical' ? '匹配主数据后自动填入' : '匹配主数据后自动填入' }}"
          required
          readonly
          data-field="name"
          bind:change="onInput"
          label-class="field-label-bold"
        />

        <!-- 联想建议列表 -->
        <view class="suggestion-box" wx:if="{{ suggestions.length > 0 }}">
            <view class="suggestion-header">
                <text>以下为可能匹配的物料</text>
                <van-icon name="cross" bind:click="closeSuggestions" class="close-icon" />
            </view>
            <view class="suggestion-list">
                <view class="suggestion-item border-bottom"
                      wx:for="{{ suggestions }}" wx:key="product_code"
                      bindtap="onSelectSuggestion"
                      data-item="{{ item }}">
                    <view class="flex-1">
                        <view class="flex-row items-center mb-5">
                            <text class="text-lg font-bold text-primary mr-5">{{ item.product_code }}</text>
                            <view class="category-tag-pill">{{ item.sub_category || '常规' }}</view>
                        </view>
                        <view class="text-sm text-dark">{{ item.name }}</view>
                        <view class="text-xs text-gray-400 mt-5" wx:if="{{item.supplier}}">供应商: {{ item.supplier }}</view>
                    </view>
                    <van-icon name="guide-o" color="#1989fa" size="18px" />
                </view>
            </view>
        </view>

        <!-- 3. 详细分类 -->
        <van-field
            label="子类别"
            value="{{ form.sub_category }}"
            placeholder="自动填入"
            readonly
            required
            label-class="field-label-bold"
        />

        <!-- 4. 供应商型号 -->
        <van-field
          value="{{ form.supplier_model }}"
          label="原厂型号"
          placeholder="请输入 (选填)"
          data-field="supplier_model"
          bind:change="onInput"
        />

        <!-- 5. 供应商 -->
        <van-field
          value="{{ form.supplier }}"
          label="供应商"
          placeholder="请输入 (选填)"
          data-field="supplier"
          bind:change="onInput"
        />

        <!-- 6. 批号 -->
        <van-field
          value="{{ form.batch_number }}"
          label="生产批号"
          placeholder="无批号请填: 当前日期 (如 20260101)"
          required
          data-field="batch_number"
          bind:change="onInput"
          label-class="field-label-bold"
        />

        <!-- 7. 库位管理 -->
        <van-cell
            title="存储区域"
            value="{{ form.location_zone || '请选择' }}"
            is-link
            bind:click="showLocationSheet"
            required
            title-class="field-label-bold"
        />
        <van-field
          value="{{ form.location_detail }}"
          label="详细坐标"
          placeholder="层-列 (如: A-01)"
          data-field="location_detail"
          bind:change="onInput"
        />
      </van-cell-group>

    <!-- 规格属性 (Hidden if Unknown Code) -->
    <view class="mb-15">
      <van-cell-group title="规格属性">
        <!-- 化材规格 -->
        <block wx:if="{{ activeTab === 'chemical' }}">
          <!-- A+B. 净含量 + 单位 -->
          <van-field
            value="{{ form.net_content }}"
            label="净含量"
            type="digit"
            placeholder="请输入数字"
            required
            data-field="net_content"
            bind:change="onInput"
            use-button-slot
            label-class="field-label-bold"
          >
              <view slot="button" class="flex-row items-center" bindtap="showUnitSheet">
                 <text class="mr-5">{{ form.unit || '单位' }}</text>
                 <van-icon name="arrow-down" size="12px" />
              </view>
          </van-field>

          <!-- C. 包装形式 -->
          <van-cell
            title="包装形式"
            value="{{ form.package_type || '请选择' }}"
            is-link
            bind:click="showPackageTypeSheet"
          />

          <!-- D. Expiry -->
          <van-cell title="过期日期" value="{{ form.expiry_date || '请选择' }}" is-link bind:click="showDatePicker" required title-class="field-label-bold" />
        </block>

        <!-- 膜材规格 -->
        <block wx:else>
            <van-field
              value="{{ form.thickness_um }}"
              label="厚度(μm)"
              type="number"
              placeholder="请输入"
              required
              data-field="thickness_um"
              bind:change="onInput"
              label-class="field-label-bold"
            />
            <van-field
              value="{{ form.width_mm }}"
              label="宽度(mm)"
              type="number"
              placeholder="请输入"
              required
              data-field="width_mm"
              bind:change="onInput"
              label-class="field-label-bold"
            />
            <van-field
              value="{{ form.length_m }}"
              label="长度(m)"
              type="number"
              placeholder="请输入"
              required
              data-field="length_m"
              bind:change="onInput"
              label-class="field-label-bold"
            />
            <van-cell title="过期日期" value="{{ form.expiry_date || '请选择' }}" is-link bind:click="showDatePicker" required title-class="field-label-bold" />
        </block>
      </van-cell-group>
    </view>

    <!-- 底部按钮 -->
    <view style="margin-top: 15px; margin-bottom: 30px; padding-bottom: constant(safe-area-inset-bottom); padding-bottom: env(safe-area-inset-bottom);">
      <van-button type="primary" block round loading="{{ loading }}" bind:click="onSubmit">
        绑定标签并入库
      </van-button>
    </view>
    </view>
    </view>

  <!-- 动作面板：单位选择 -->
  <van-action-sheet
    show="{{ showUnitSheet }}"
    actions="{{ unitActions }}"
    bind:close="onUnitClose"
    bind:select="onUnitSelect"
  />

  <!-- 包装形式选择 -->
  <van-action-sheet
    show="{{ showPackageTypeSheet }}"
    actions="{{ packageTypeActions }}"
    bind:close="onPackageTypeClose"
    bind:select="onPackageTypeSelect"
  />

  <!-- 详细分类选择器 -->
  <van-action-sheet
    show="{{ showSubCategorySheet }}"
    actions="{{ subCategoryActions }}"
    bind:close="onSubCategoryClose"
    bind:select="onSubCategorySelect"
  />

  <!-- 库位区域选择器 -->
  <van-action-sheet
    show="{{ showLocationSheet }}"
    actions="{{ locationZoneActions }}"
    bind:close="onLocationClose"
    bind:select="onLocationSelect"
  />

  <!-- 日期选择器 -->
  <van-popup show="{{ showDatePicker }}" position="bottom" round>
    <van-datetime-picker
      type="date"
      value="{{ currentDate }}"
      min-date="{{ minDate }}"
      bind:confirm="onDateConfirm"
      bind:cancel="onDateCancel"
    />
  </van-popup>

  <!-- 申请建档-专用小类选择 -->
  <van-action-sheet
    show="{{ showRequestSubCategorySheet }}"
    actions="{{ requestSubCategoryActions }}"
    z-index="10000"
    bind:close="onRequestSubCategoryClose"
    bind:select="onRequestSubCategorySelect"
  />

  <!-- 成功弹窗 -->
  <van-dialog
    use-slot
    show="{{ showSuccessDialog }}"
    show-confirm-button="{{ false }}"
    show-cancel-button="{{ false }}"
    width="300px"
    custom-style="border-radius: 16px;"
  >
    <view class="success-dialog-body">
      <!-- Icon & Text -->
      <view class="text-center pt-30 pb-20">
        <van-icon name="checked" color="#07c160" size="64px" />
        <view class="mt-15 font-bold text-xl text-dark">入库成功</view>
        <view class="mt-10 text-md text-dark">已绑定标签: <text class="font-bold">{{ form.unique_code }}</text></view>
        <view class="text-xs text-gray-400 mt-5">数据已安全存入数据库</view>
      </view>

      <!-- Vertical Button Stack -->
      <view class="p-20">
        <van-button type="primary" block round bind:click="onNextOne" custom-class="mb-10 box-shadow-blue">
          保存并继续
        </van-button>
        <van-button type="default" block round bind:click="onSuccessBack" custom-class="text-gray-dark bg-gray-light border-none">
          返回首页
        </van-button>
      </view>
    </view>
  </van-dialog>

  <!-- 申请建档弹窗 -->
  <van-popup
    show="{{ showRequestPopup }}"
    position="bottom"
    round
    custom-style="max-height: 80%;"
    z-index="5000"
    bind:close="onCloseRequestPopup"
  >
      <view class="pb-30 pt-20">
        <view class="text-center text-lg font-bold mb-20 text-dark">申请建立新档案</view>

        <van-cell-group>
          <van-field label="大类(自动)" value="{{ activeTab === 'chemical' ? '化材' : '膜材' }}" readonly />
          <van-field label="代码(自动)" value="{{ form.product_code }}" readonly />

          <van-field
            label="物料名称"
            value="{{ requestForm.name }}"
            placeholder="请输入物料名称 (必填)"
            required
            data-field="name"
            bind:change="onRequestInput"
          />

          <van-cell
              title="建议子类别"
              value="{{ requestForm.sub_category || '请选择' }}"
              is-link
              required
              bind:click="showRequestSubCategorySheet"
          />

          <!-- 选择了"其他"时显示输入框：兼容两种数据格式 -->
          <van-field
            wx:if="{{ requestForm.sub_category === '其他' || requestForm.sub_category === '其他 (Other)' }}"
            label="建议子类别名称"
            value="{{ requestForm.suggested_sub_category }}"
            placeholder="请输入建议的小类名称 (选填)"
            data-field="suggested_sub_category"
            bind:change="onRequestInput"
          />

          <van-field
            label="参考供应商"
            value="{{ requestForm.supplier }}"
            placeholder="请输入供应商 (选填)"
            data-field="supplier"
            bind:change="onRequestInput"
          />
        </van-cell-group>

        <view class="pb-30" style="margin-top: 50px;">
          <van-button type="info" block round bind:click="onSubmitRequest" loading="{{ requestLoading }}">提交申请</van-button>
        </view>
    </view>
  </van-popup>

  <van-toast id="van-toast" />
</view>
